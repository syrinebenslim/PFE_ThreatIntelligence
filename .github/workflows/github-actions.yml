name: Threat Intelligence GitHub Actions CI/CD pipeline
on: [push]

jobs:
  Explore-GitHub-Actions:
    runs-on: self-hosted

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Debug VM variables
        run: |
          echo "User: ${{ vars.VM_USER }}"
          echo "IP: ${{ vars.VM_IP }}"

      - name: Test VM connectivity
        run: |
          ping -c 4 ${{ vars.VM_IP }}

      - name: Deploy to Local VM
        env:
          VM_USER: ${{ vars.VM_USER }}
          VM_PASSWORD: ${{ vars.VM_PASSWORD }}
          VM_IP: ${{ vars.VM_IP }}
        run: |
          # Installer sshpass
          sudo apt-get update && sudo apt-get install -y sshpass
          
          # Copier le fichier sur la VM
          sshpass -p "$VM_PASSWORD" scp dist/*.whl $VM_USER@$VM_IP:/tmp/

          # SSH dans la VM et ex√©cuter les commandes
          sshpass -p "$VM_PASSWORD" ssh -v -o StrictHostKeyChecking=no $VM_USER@$VM_IP << EOF
            python3 -m pip install /tmp/*.whl --no-cache-dir
            rm -f /tmp/*.whl
          EOF
